<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
          Sign in with Apple - undefined
        
    </title>

    <link rel="canonical" href="http://example.com/2019/09/24/20190730/">

    <!-- Bootstrap Core CSS -->
    
<link rel="stylesheet" href="/css/bootstrap.min.css">


    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/hux-blog.min.css">


    <!-- Pygments Highlight CSS -->
    
<link rel="stylesheet" href="/css/highlight.css">


    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
<meta name="generator" content="Hexo 6.3.0"></head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Qianxing&#39;s Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    
                    
                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    
<!-- Image to hack wechat -->
<!-- <img src="http://example.com/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="{{ site.baseurl }}/{% if page.header-img %}{{ page.header-img }}{% else %}{{ site.header-img }}{% endif %}" width="0" height="0"> -->

<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        background-image: url('/undefined')
    }
</style>
<header class="intro-header" >
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                          <a class="tag" href="/tags/#iOS" title="iOS">iOS</a>
                        
                    </div>
                    <h1>Sign in with Apple</h1>
                    <h2 class="subheading"></h2>
                    <span class="meta">
                        Posted by Qianxing on
                        2019-09-24
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <p>文章已发布至公账号：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzI0MzgxNDkyNw==&mid=2247483656&idx=1&sn=41c79bb9a971d4aedb89977a24d872a1&chksm=e9660668de118f7e7630d48454734ee872bba7065981db97acb04ac131bb3acb177cc2cdc448&token=395919763&lang=zh_CN#rd">Sign in with Apple</a></p>
<blockquote>
<p>通过本文，你将了解到是否需要集成<code>Sign in with Apple</code>功能，以及如何集成<code>Sign in with Apple</code>功能。</p>
</blockquote>
<p>本文主要讲解以下内容</p>
<ul>
<li>概览</li>
<li>集成</li>
</ul>
<h1 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h1><p>在 WWDC 2019 上，苹果推出了自家的<code>Sign in with Apple</code>功能，这很<code>Apple</code>。可能苹果看到第三方登录百家争鸣，琢磨着自己也搞了个，这对很多第三方登录来说可能是个威胁。</p>
<p>苹果对<code>Sign in with Apple</code>的介绍：</p>
<blockquote>
<p>Sign In with Apple makes it easy for users to sign in to your apps and websites using their Apple ID. Instead of filling out forms, verifying email addresses, and choosing new passwords, they can use Sign In with Apple to set up an account and start using your app right away. All accounts are protected with two-factor authentication for superior security, and Apple will not track users’ activity in your app or website.</p>
</blockquote>
<p>使用<code>Sign in with Apple</code>会更加方便、快捷、安全，苹果不会追踪用户在应用中的行为。所以，对于用户来说使用<code>Sign in with Apple</code>会更加安全。</p>
<p>另外，<code>Sign in with Apple</code>支持跨平台</p>
<ul>
<li>Native SDK 支持 iOS&#x2F;MacOS&#x2F;watchOS&#x2F;tvOS</li>
<li>Javascript SDK 支持  Android, Windows, Web</li>
</ul>
<p>话说这个 iOS 13 才支持的功能，我们有必要集成吗？🤔</p>
<p>看了下面这句话，你或许就有答案了。</p>
<blockquote>
<p>Sign In with Apple will be available for beta testing this summer. It will be required as an option for users in apps that support third-party sign-in when it is commercially available later this year.</p>
</blockquote>
<p>简单来说，如果你的<code>App</code>没有提供第三方登录，那就不用集成。如果用到了第三方登录，那么需要提供<code>Sign in with Apple</code>。</p>
<h1 id="集成"><a href="#集成" class="headerlink" title="集成"></a>集成</h1><p>集成 需要以下几个步骤：</p>
<p><img src="https://raw.githubusercontent.com/jixuqianxing/BlogResources/main/20190730/1.png"></p>
<h2 id="一、准备工作"><a href="#一、准备工作" class="headerlink" title="一、准备工作"></a>一、准备工作</h2><p>开启<code>Sign in with Apple</code>功能</p>
<p>1.登录开发者网站，在需要添加<code>Sign in with Apple</code>功能的<code>Identifier</code>开启功能。</p>
<p><img src="https://raw.githubusercontent.com/jixuqianxing/BlogResources/main/20190730/2.png"></p>
<p>2.<code>Xcode</code>里面<code>Signing &amp; Capabilities</code>开启<code>Sign in with Apple</code>功能。</p>
<p><img src="https://raw.githubusercontent.com/jixuqianxing/BlogResources/main/20190730/3.png"></p>
<h2 id="二、代码集成"><a href="#二、代码集成" class="headerlink" title="二、代码集成"></a>二、代码集成</h2><blockquote>
<p>Talk is cheap. Show me the code！😌</p>
</blockquote>
<h4 id="1-创建登录按钮"><a href="#1-创建登录按钮" class="headerlink" title="1.创建登录按钮"></a>1.创建登录按钮</h4><p>官方提供了一个<code>ASAuthorizationAppleIDButton</code>（继承自<code>UIControl</code>），使用这个来创建一个登录按钮。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ASAuthorizationAppleIDButton *button = [ASAuthorizationAppleIDButton buttonWithType:ASAuthorizationAppleIDButtonTypeSignIn style:ASAuthorizationAppleIDButtonStyleWhite];</span><br><span class="line">[button addTarget:self</span><br><span class="line">           action:@selector(signInWithApple)</span><br><span class="line"> forControlEvents:UIControlEventTouchUpInside];</span><br><span class="line">button.center = self.view.center;</span><br><span class="line">[self.view addSubview:button];</span><br></pre></td></tr></table></figure>


<p>这个按钮具有两种文案类型和三个样式，分别是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">typedef NS_ENUM(NSInteger, ASAuthorizationAppleIDButtonType) &#123;</span><br><span class="line">    ASAuthorizationAppleIDButtonTypeSignIn,</span><br><span class="line">    ASAuthorizationAppleIDButtonTypeContinue,</span><br><span class="line"></span><br><span class="line">    ASAuthorizationAppleIDButtonTypeDefault = ASAuthorizationAppleIDButtonTypeSignIn,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">typedef NS_ENUM(NSInteger, ASAuthorizationAppleIDButtonStyle) &#123;</span><br><span class="line">    ASAuthorizationAppleIDButtonStyleWhite,</span><br><span class="line">    ASAuthorizationAppleIDButtonStyleWhiteOutline,</span><br><span class="line">    ASAuthorizationAppleIDButtonStyleBlack,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过图片可能更直观</p>
<p><img src="https://raw.githubusercontent.com/jixuqianxing/BlogResources/main/20190730/4.jpeg"></p>
<p>从图上可以看出：</p>
<ul>
<li>Apple 提供的登录按钮有三种外观：白色，带有黑色轮廓线的白色和黑色。</li>
<li>文案有两种：<code>Sign In with Apple</code> 和 <code>Continue with Apple</code>。（具体使用哪个文案，根据自身业务需求来定）<br>另外，按钮宽高默认值为 <code>&#123;width:130, height:30&#125;</code>。</li>
</ul>
<p>对于<code>ASAuthorizationAppleIDButton</code>我们能够自定义的东西比较少，比如背景色不能更改，文案只有两种可选，并且值不能修改，可以调整的只有圆角<code>cornerRadius</code>和<code>size</code>。</p>
<p><img src="https://raw.githubusercontent.com/jixuqianxing/BlogResources/main/20190730/5.png"></p>
<p>宽高也有一定限制：</p>
<table>
<thead>
<tr>
<th>Minimum width</th>
<th>Minimum height</th>
<th>Minimum margin</th>
</tr>
</thead>
<tbody><tr>
<td>140pt (140px @1x, 280px @2x)</td>
<td>30pt (30px @1x, 60px @2x)</td>
<td>1&#x2F;10 of the button’s height</td>
</tr>
</tbody></table>
<p>具体的设计规范，请参考：<a target="_blank" rel="noopener" href="https://developer.apple.com/design/human-interface-guidelines/sign-in-with-apple">Human Interface Guidelines</a></p>
<p>通过调整<code>size</code>发现还有个新花样。比如这样：</p>
<p><img src="https://raw.githubusercontent.com/jixuqianxing/BlogResources/main/20190730/6.png"></p>
<p>是不是发现文字没有了，当然有些童鞋可能会说，变成圆形的了。嗯，圆形还是比较简单设置的，主要的变化还是文字。同时，我们还可以发现，在这种情况下，调大尺寸，里面的苹果 logo 也会跟着变大，适应展示。具体怎么操作，看下面：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ASAuthorizationAppleIDButton *button = [ASAuthorizationAppleIDButton buttonWithType:ASAuthorizationAppleIDButtonTypeContinue style:ASAuthorizationAppleIDButtonStyleBlack];</span><br><span class="line">button.bounds = CGRectMake(0, 0, 40, 40);</span><br><span class="line">button.cornerRadius = 20.0f;</span><br></pre></td></tr></table></figure>

<p>不过上面这种方式，不知道审核是否可以通过哈，大家还是慎用，仅作为一种参考。不过，苹果貌似没有强制使用默认的登录按钮。</p>
<blockquote>
<p>To help people set up an account and sign in, it’s best to use the familiar buttons that Apple provides for Sign In with Apple.</p>
</blockquote>
<p>再补充一点，通过上面这种修改<code>size</code>后，会收到布局警告⚠️，通过警告信息，大致可以看出来，按钮宽度的范围是：<code>&gt;= 130px</code>，高度范围是：<code>&gt;=30px &amp;&amp; &lt;=64px</code>。</p>
<p><strong>本地化</strong>：必要且重要的一点</p>
<p>不知道大家有没有发现，按钮显示的文字都是英文的，而且我们不可以修改文字，那我总不能在国内也展示个英文吧🙄。其实，这是个基础性的问题，知道的童鞋可以跳过了，不清楚的童鞋继续看。解决这个问题，很简单，要知道<code>Apple</code>已经为我们做了很多的工作，简单来说，我们只需要添加本地化支持就可以了，此方法适用于一切系统文案，比如我们创建的<code>UIBarButtonSystemItemSave</code>，添加简体中文支持后，他显示的文案就变成 保存 啦。</p>
<p><img src="https://raw.githubusercontent.com/jixuqianxing/BlogResources/main/20190730/7.jpeg"></p>
<p>上图就是添加本地化语言，还不会的童鞋，自己网上查查吧，这里不在展开了。</p>
<p>下面是添加了本地语言之后的效果：</p>
<p><img src="https://raw.githubusercontent.com/jixuqianxing/BlogResources/main/20190730/8.jpeg"></p>
<h4 id="2-Authorization-发起授权登录请求"><a href="#2-Authorization-发起授权登录请求" class="headerlink" title="2.Authorization 发起授权登录请求"></a>2.Authorization 发起授权登录请求</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (void)signInWithApple API_AVAILABLE(ios(13.0))</span><br><span class="line">&#123;</span><br><span class="line">    ASAuthorizationAppleIDProvider *provider = [[ASAuthorizationAppleIDProvider alloc] init];</span><br><span class="line">    ASAuthorizationAppleIDRequest *request = [provider createRequest];</span><br><span class="line">    request.requestedScopes = @[ASAuthorizationScopeFullName, ASAuthorizationScopeEmail];</span><br><span class="line">    </span><br><span class="line">    ASAuthorizationController *vc = [[ASAuthorizationController alloc] initWithAuthorizationRequests:@[request]];</span><br><span class="line">    vc.delegate = self;</span><br><span class="line">    vc.presentationContextProvider = self;</span><br><span class="line">    [vc performRequests];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解析：</p>
<ul>
<li><p><code>ASAuthorizationAppleIDProvider</code>这个类比较简单，头文件中可以看出，主要用于创建一个<code>ASAuthorizationAppleIDRequest</code>以及获取对应<code>userID</code>的用户授权状态。在上面的方法中我们主要是用于创建一个<code>ASAuthorizationAppleIDRequest</code>，用户授权状态的获取后面会提到。</p>
</li>
<li><p>给创建的<code>request</code>设置<code>requestedScopes</code>，这是个<code>ASAuthorizationScope</code>数组，目前只有两个值，<code>ASAuthorizationScopeFullName</code>和 <code>ASAuthorizationScopeEmail</code>，根据需求去设置即可。</p>
</li>
<li><p>然后，创建<code>ASAuthorizationController</code>，它是管理授权请求的控制器，给其设置 <code>delegate</code>和<code>presentationContextProvider</code>，最后启动授权<code>performRequests</code>。</p>
</li>
</ul>
<p><strong>设置上下文</strong></p>
<p><code>ASAuthorizationControllerPresentationContextProviding</code>就一个方法，主要是告诉<code>ASAuthorizationController</code>展示在哪个<code>window</code>上。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#pragma mark - ASAuthorizationControllerPresentationContextProviding</span><br><span class="line"></span><br><span class="line">- (ASPresentationAnchor)presentationAnchorForAuthorizationController:(ASAuthorizationController *)controller API_AVAILABLE(ios(13.0))</span><br><span class="line">&#123;</span><br><span class="line">    return self.view.window;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-Verification-授权"><a href="#3-Verification-授权" class="headerlink" title="3.Verification 授权"></a>3.Verification 授权</h4><p>用户发起授权请求后，系统就会弹出用户登录验证的页面。</p>
<p><img src="https://raw.githubusercontent.com/jixuqianxing/BlogResources/main/20190730/9.jpeg"></p>
<p>在用户没有同意授权之前或者取消授权之后，点击登录的时候，都会弹出上面这个界面，在这个授权页面，我们可以修改自己的用户名，以及可以选择共享我的电子邮箱或者隐藏邮件地址。这样一来，就可以达到隐藏自己真实信息的目的。</p>
<p>授权一次后，再次点击登录按钮，则会直接弹出下面这个窗口：</p>
<p><img src="https://raw.githubusercontent.com/jixuqianxing/BlogResources/main/20190730/10.jpeg"></p>
<p><strong>授权回调处理</strong></p>
<p>下面是<code>ASAuthorizationControllerDelegate</code>方法，一个是授权成功的回调，一个是失败的回调。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">#pragma mark - ASAuthorizationControllerDelegate</span><br><span class="line"></span><br><span class="line">- (void)authorizationController:(ASAuthorizationController *)controller didCompleteWithAuthorization:(ASAuthorization *)authorization API_AVAILABLE(ios(13.0))</span><br><span class="line">&#123;</span><br><span class="line">    if ([authorization.credential isKindOfClass:[ASAuthorizationAppleIDCredential class]])       &#123;</span><br><span class="line">        ASAuthorizationAppleIDCredential *credential = authorization.credential;</span><br><span class="line">        </span><br><span class="line">        NSString *state = credential.state;</span><br><span class="line">        NSString *userID = credential.user;</span><br><span class="line">        NSPersonNameComponents *fullName = credential.fullName;</span><br><span class="line">        NSString *email = credential.email;</span><br><span class="line">        NSString *authorizationCode = [[NSString alloc] initWithData:credential.authorizationCode encoding:NSUTF8StringEncoding]; // refresh token</span><br><span class="line">        NSString *identityToken = [[NSString alloc] initWithData:credential.identityToken encoding:NSUTF8StringEncoding]; // access token</span><br><span class="line">        ASUserDetectionStatus realUserStatus = credential.realUserStatus;</span><br><span class="line">        </span><br><span class="line">        NSLog(@&quot;state: %@&quot;, state);</span><br><span class="line">        NSLog(@&quot;userID: %@&quot;, userID);</span><br><span class="line">        NSLog(@&quot;fullName: %@&quot;, fullName);</span><br><span class="line">        NSLog(@&quot;email: %@&quot;, email);</span><br><span class="line">        NSLog(@&quot;authorizationCode: %@&quot;, authorizationCode);</span><br><span class="line">        NSLog(@&quot;identityToken: %@&quot;, identityToken);</span><br><span class="line">        NSLog(@&quot;realUserStatus: %@&quot;, @(realUserStatus));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)authorizationController:(ASAuthorizationController *)controller didCompleteWithError:(NSError *)error API_AVAILABLE(ios(13.0))</span><br><span class="line">&#123;</span><br><span class="line">    NSString *errorMsg = nil;</span><br><span class="line">    switch (error.code) &#123;</span><br><span class="line">        case ASAuthorizationErrorCanceled:</span><br><span class="line">            errorMsg = @&quot;用户取消了授权请求&quot;;</span><br><span class="line">            break;</span><br><span class="line">        case ASAuthorizationErrorFailed:</span><br><span class="line">            errorMsg = @&quot;授权请求失败&quot;;</span><br><span class="line">            break;</span><br><span class="line">        case ASAuthorizationErrorInvalidResponse:</span><br><span class="line">            errorMsg = @&quot;授权请求响应无效&quot;;</span><br><span class="line">            break;</span><br><span class="line">        case ASAuthorizationErrorNotHandled:</span><br><span class="line">            errorMsg = @&quot;未能处理授权请求&quot;;</span><br><span class="line">            break;</span><br><span class="line">        case ASAuthorizationErrorUnknown:</span><br><span class="line">            errorMsg = @&quot;授权请求失败未知原因&quot;;</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">    NSLog(@&quot;%@&quot;, errorMsg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当我们授权成功后，我们可以在 <code>authorizationController:didCompleteWithAuthorization:</code>这个代理方法中获取到<code>ASAuthorizationAppleIDCredential</code>，通过这个可以拿到用户的<code>userID</code>、<code>email</code>、<code>fullName</code>、<code>authorizationCode</code>、<code>identityToken</code>以及 <code>realUserStatus</code>等信息。</p>
<p>这些信息具体含义和用途：</p>
<ul>
<li><p><code>User ID</code>: Unique, stable, team-scoped user ID，苹果用户唯一标识符，该值在同一个开发者账号下的所有 App 下是一样的，开发者可以用该唯一标识符与自己后台系统的账号体系绑定起来。</p>
</li>
<li><p><code>Verification data</code>: Identity token, code，验证数据，用于传给开发者后台服务器，然后开发者服务器再向苹果的身份验证服务端验证本次授权登录请求数据的有效性和真实性，详见 Sign In with Apple REST API。如果验证成功，可以根据 userIdentifier 判断账号是否已存在，若存在，则返回自己账号系统的登录态，若不存在，则创建一个新的账号，并返回对应的登录态给 App。</p>
</li>
<li><p><code>Account information</code>: Name, verified email，苹果用户信息，包括全名、邮箱等。</p>
</li>
<li><p><code>Real user indicator</code>: High confidence indicator that likely real user，用于判断当前登录的苹果账号是否是一个真实用户，取值有：unsupported、unknown、likelyReal。</p>
</li>
</ul>
<p>失败情况会走<code>authorizationController:didCompleteWithError:</code>这个方法，具体看代码吧。</p>
<h4 id="5-Handling-Changes"><a href="#5-Handling-Changes" class="headerlink" title="5. Handling Changes"></a>5. Handling Changes</h4><p>通过上面的步骤一个完整的授权，已经完成。BUT，我们还需要处理一些 Case。</p>
<ul>
<li>用户终止<code>App</code>中使用<code>Sign in with Apple</code>功能</li>
<li>用户在设置里注销了<code>AppleId</code></li>
</ul>
<p>这些情况下，<code>App</code>需要获取到这些状态，然后做退出登录操作，或者重新登录。<br>我们需要在<code>App</code>启动的时候，通过<code>getCredentialState:completion:</code>来获取当前用户的授权状态。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions &#123;</span><br><span class="line">    </span><br><span class="line">    if (@available(iOS 13.0, *)) &#123;</span><br><span class="line">        NSString *userIdentifier = 钥匙串中取出的 userIdentifier;</span><br><span class="line">        if (userIdentifier) &#123;</span><br><span class="line">            ASAuthorizationAppleIDProvider *appleIDProvider = [ASAuthorizationAppleIDProvider new];</span><br><span class="line">            [appleIDProvider getCredentialStateForUserID:userIdentifier</span><br><span class="line">                                              completion:^(ASAuthorizationAppleIDProviderCredentialState credentialState,</span><br><span class="line">                                                           NSError * _Nullable error)</span><br><span class="line">            &#123;</span><br><span class="line">                switch (credentialState) &#123;</span><br><span class="line">                    case ASAuthorizationAppleIDProviderCredentialAuthorized:</span><br><span class="line">                        // The Apple ID credential is valid</span><br><span class="line">                        break;</span><br><span class="line">                    case ASAuthorizationAppleIDProviderCredentialRevoked:</span><br><span class="line">                        // Apple ID Credential revoked, handle unlink</span><br><span class="line">                        break;</span><br><span class="line">                    case ASAuthorizationAppleIDProviderCredentialNotFound:</span><br><span class="line">                        // Credential not found, show login UI</span><br><span class="line">                        break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return YES;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><code>ASAuthorizationAppleIDProviderCredentialState</code>解析如下：</p>
<ul>
<li><p><code>ASAuthorizationAppleIDProviderCredentialAuthorized</code>授权状态有效；</p>
</li>
<li><p><code>ASAuthorizationAppleIDProviderCredentialRevoked</code>上次使用苹果账号登录的凭据已被移除，需解除绑定并重新引导用户使用苹果登录；</p>
</li>
<li><p><code>ASAuthorizationAppleIDProviderCredentialNotFound</code>未登录授权，直接弹出登录页面，引导用户登录。</p>
</li>
</ul>
<p>另外，在<code>App</code>使用过程中，你还可以通过通知方法来监听<code>revoked</code>状态，可以添加 <code>ASAuthorizationAppleIDProviderCredentialRevokedNotification</code>这个通知，收到这个通知的时候，我们可以：</p>
<ul>
<li>Sign user out on this device</li>
<li>Guide to sign in again</li>
</ul>
<p>具体怎么添加和处理，可以根据业务需求来决定。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- (void)observeAppleSignInState</span><br><span class="line">&#123;</span><br><span class="line">    if (@available(iOS 13.0, *)) &#123;</span><br><span class="line">        [[NSNotificationCenter defaultCenter] addObserver:self</span><br><span class="line">                                                 selector:@selector(handleSignInWithAppleStateChanged:)</span><br><span class="line">                                                     name:ASAuthorizationAppleIDProviderCredentialRevokedNotification</span><br><span class="line">                                                   object:nil];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)handleSignInWithAppleStateChanged:(NSNotification *)notification</span><br><span class="line">&#123;</span><br><span class="line">    // Sign the user out, optionally guide them to sign in again</span><br><span class="line">    NSLog(@&quot;%@&quot;, notification.userInfo);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="One-more-thing"><a href="#One-more-thing" class="headerlink" title="One more thing"></a>One more thing</h2><p>除此之外，苹果还把<code>iCloud KeyChain password</code>集成到了这套<code>API</code>里，我们在使用的时候，只需要在创建<code>request</code>的时候，多创建一个<code>ASAuthorizationPasswordRequest</code>，这样如果<code>KeyChain</code>里面也有登录信息的话，可以直接使用里面保存的用户名和密码进行登录。代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">- (void)perfomExistingAccountSetupFlows API_AVAILABLE(ios(13.0))</span><br><span class="line">&#123;</span><br><span class="line">    ASAuthorizationAppleIDProvider *appleIDProvider = [ASAuthorizationAppleIDProvider new];</span><br><span class="line">    ASAuthorizationAppleIDRequest *authAppleIDRequest = [appleIDProvider createRequest];</span><br><span class="line">    ASAuthorizationPasswordRequest *passwordRequest = [[ASAuthorizationPasswordProvider new] createRequest];</span><br><span class="line">    </span><br><span class="line">    NSMutableArray &lt;ASAuthorizationRequest *&gt;* array = [NSMutableArray arrayWithCapacity:2];</span><br><span class="line">    if (authAppleIDRequest) &#123;</span><br><span class="line">        [array addObject:authAppleIDRequest];</span><br><span class="line">    &#125;</span><br><span class="line">    if (passwordRequest) &#123;</span><br><span class="line">        [array addObject:passwordRequest];</span><br><span class="line">    &#125;</span><br><span class="line">    NSArray &lt;ASAuthorizationRequest *&gt;* requests = [array copy];</span><br><span class="line">    </span><br><span class="line">    ASAuthorizationController *authorizationController = [[ASAuthorizationController alloc] initWithAuthorizationRequests:requests];</span><br><span class="line">    authorizationController.delegate = self;</span><br><span class="line">    authorizationController.presentationContextProvider = self;</span><br><span class="line">    [authorizationController performRequests];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#pragma mark - ASAuthorizationControllerDelegate</span><br><span class="line"></span><br><span class="line">- (void)authorizationController:(ASAuthorizationController *)controller didCompleteWithAuthorization:(ASAuthorization *)authorization API_AVAILABLE(ios(13.0))</span><br><span class="line">&#123;</span><br><span class="line">    if ([authorization.credential isKindOfClass:[ASPasswordCredential class]]) &#123;</span><br><span class="line">        ASPasswordCredential *passwordCredential = authorization.credential;</span><br><span class="line">        NSString *userIdentifier = passwordCredential.user;</span><br><span class="line">        NSString *password = passwordCredential.password;</span><br><span class="line">        </span><br><span class="line">        NSLog(@&quot;userIdentifier: %@&quot;, userIdentifier);</span><br><span class="line">        NSLog(@&quot;password: %@&quot;, password);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上就是关于<code>Sign in with Apple</code>的相关内容和集成方法。</p>


                <hr>

                

                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/2021/10/29/20211029/" data-toggle="tooltip" data-placement="top" title="iOS 如何更好的适配异形屏（刘海屏）">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/2019/06/10/20190610/" data-toggle="tooltip" data-placement="top" title="iOS 13 适配">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                

                

            </div>
    <!-- Side Catalog Container -->
        

    <!-- Sidebar Container -->

            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                

                <!-- Friends Blog -->
                
            </div>

        </div>
    </div>
</article>









    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                
                

                

                

                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Qianxing&#39;s Blog 2023 
                    <br>
                    Theme by <a target="_blank" rel="noopener" href="http://huangxuan.me">Hux</a> 
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span> 
                    Ported by <a target="_blank" rel="noopener" href="http://blog.kaijun.rocks">Kaijun</a> | 
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=kaijun&repo=hexo-theme-huxblog&type=star&count=true" >
                    </iframe>
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->

<script src="/js/jquery.min.js"></script>


<!-- Bootstrap Core JavaScript -->

<script src="/js/bootstrap.min.js"></script>


<!-- Custom Theme JavaScript -->

<script src="/js/hux-blog.min.js"></script>



<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- 
     Because of the native support for backtick-style fenced code blocks 
     right within the Markdown is landed in Github Pages, 
     From V1.6, There is no need for Highlight.js, 
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0  
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/    
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->


<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("http://example.com/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->




<!-- Baidu Tongji -->


<!-- Side Catalog -->





<!-- Image to hack wechat -->
<img src="http://example.com/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
